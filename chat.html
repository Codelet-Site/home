<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Codelet â€¢ Chat</title>
<link rel="stylesheet" href="style.css">
</head>
<body class="app-layout">
  <div class="page-wrapper">
    <aside class="sidebar">
      <h2>Codelet</h2>
      <a class="side-link" href="dashboard.html">Dashboard</a>
      <a class="side-link" href="chat.html" style="background:#550000">Chat</a>
      <a class="side-link" href="codes.html">Codets</a>
      <a class="side-link" href="market.html">Market</a>
      <a class="side-link" href="settings.html">Settings</a>
      <button id="logoutBtn" class="logout">Log Out</button>
    </aside>

    <main>
      <h1 style="color:var(--accent); margin-top:0;">Global Chat</h1>

      <div class="chat-container" style="background:var(--panel); border:1px solid var(--border); padding:18px; border-radius:12px;">
        <div id="messages" style="height:65vh; overflow-y:auto; padding-right:8px;"></div>

        <div style="display:flex; gap:10px; margin-top:12px; align-items:center;">
          <input id="msgInput" placeholder="Type a message..." style="flex:1; padding:12px; border-radius:10px; border:none; background:#520000; color:#fff;">
          <button id="sendBtn" style="padding:12px 16px; border-radius:10px; border:none; background:var(--accent); color:#fff; font-weight:600;">Send</button>
        </div>
      </div>
    </main>
  </div>

<script type="module">
  // import the exported auth & db from auth.js
  import { auth, db } from "./auth.js";

  // Firestore functions
  import {
    collection,
    addDoc,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const messagesEl = document.getElementById("messages");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");

  let username = "Unknown";

  // Wait for auth state, then fetch username
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // redirect handled by auth.js guard, but just in case:
      window.location.href = "login.html";
      return;
    }

    // load user profile to get username
    const snap = await getDoc(doc(db, "users", user.uid));
    if (snap.exists()) {
      const data = snap.data();
      username = data.username || (user.email ? user.email.split("@")[0] : "User");
    }
  });

  // realtime listener for chat collection
  const q = query(collection(db, "chat"), orderBy("timestamp", "asc"));
  onSnapshot(q, (snapshot) => {
    messagesEl.innerHTML = ""; // clear then re-add (simple approach)

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const wrapper = document.createElement("div");
      wrapper.className = "message";
      wrapper.style.marginBottom = "10px";
      wrapper.style.padding = "10px";
      wrapper.style.borderRadius = "10px";
      wrapper.style.background = "#550000";

      const who = document.createElement("div");
      who.className = "sender";
      who.textContent = data.username || "Unknown";
      who.style.fontWeight = "700";
      who.style.color = "var(--accent)";
      who.style.marginBottom = "6px";

      const text = document.createElement("div");
      text.textContent = data.text || "";

      wrapper.appendChild(who);
      wrapper.appendChild(text);

      messagesEl.appendChild(wrapper);
    });

    // auto-scroll to bottom
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  // send message
  sendBtn.addEventListener("click", async () => {
    const text = msgInput.value.trim();
    if (!text) return;

    try {
      await addDoc(collection(db, "chat"), {
        username,
        text,
        timestamp: serverTimestamp()
      });
      msgInput.value = "";
    } catch (err) {
      console.error("Send failed", err);
    }
  });

  // allow enter to send
  msgInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });
</script>
</body>
</html>
